<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Three.js Rocket Zoom Scene</title>
  <style>
      body { margin: 0; overflow: hidden; background: #000; }
      canvas { display: block; }
  </style>

  <!-- ✅ โหลด Tween.js (แก้ปัญหา TWEEN not defined) -->
  <script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>

  <!-- ✅ โหลด Three.js และส่วนเสริม -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dat.gui/build/dat.gui.min.js"></script>
</head>
<body>
<script>
  // ======================
  // 🔧 Basic Setup
  // ======================
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  renderer.outputEncoding = THREE.sRGBEncoding;
  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000010); // สีพื้นหลังเข้มแบบอวกาศ

  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 5, 15);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;

  // ======================
  // 💡 Lights
  // ======================
  const dirLight = new THREE.DirectionalLight(0xffffff, 1.8);
  dirLight.position.set(5, 10, 5);
  dirLight.castShadow = true;
  scene.add(dirLight);

  const ambient = new THREE.AmbientLight(0xffffff, 0.7);
  scene.add(ambient);

  // ======================
  // 🌍 Ground (พื้นรับเงา)
  // ======================
  const planeGeometry = new THREE.PlaneGeometry(40, 40);
  const planeMaterial = new THREE.ShadowMaterial({ opacity: 0.3 });
  const plane = new THREE.Mesh(planeGeometry, planeMaterial);
  plane.rotation.x = -Math.PI / 2;
  plane.position.y = 0;
  plane.receiveShadow = true;
  scene.add(plane);

  // ======================
  // 🚀 Loaders
  // ======================
  const loader = new THREE.GLTFLoader();

  // ----- Step 1: โหลดจรวดก่อน -----
  loader.load(
      './text1.glb',
      function (rocketGltf) {
          rocketGltf.scene.traverse(function (child) {
              if (child.isMesh) {
                  child.castShadow = true;
                  child.receiveShadow = true;
              }
          });

          rocketGltf.scene.scale.set(1, 1, 1);
          rocketGltf.scene.position.set(0, 0, 0);
          rocketGltf.scene.rotation.y = Math.PI;
          scene.add(rocketGltf.scene);

          console.log('🚀 Rocket model loaded!');

          // ตั้งกล้องให้มองจรวดก่อน
          const box = new THREE.Box3().setFromObject(rocketGltf.scene);
          const center = box.getCenter(new THREE.Vector3());
          controls.target.copy(center);
          camera.lookAt(center);

          // โหลดโมเดลหลักภายหลัง (หน่วงเวลา 3 วิ)
          setTimeout(() => loadMainModel(), 3000);
      },
      (xhr) => console.log(`Rocket loading: ${(xhr.loaded / xhr.total * 100).toFixed(2)}%`),
      (error) => console.error('❌ Rocket load error:', error)
  );

  // ----- Step 2: โหลดโมเดลหลัก -----
  function loadMainModel() {
      loader.load(
          './pj.glb',
          function (gltf) {
              gltf.scene.traverse(function (child) {
                  if (child.isMesh) {
                      child.castShadow = true;
                      child.receiveShadow = true;
                  }
              });

              gltf.scene.scale.set(1, 1, 1);
              gltf.scene.position.set(0, 0, 0);
              gltf.scene.rotation.y = Math.PI;
              scene.add(gltf.scene);

              console.log('✅ Main model loaded!');

              // ซูมกล้องเข้าหาโมเดลหลัก
              new TWEEN.Tween(camera.position)
                  .to({ x: 0, y: 3, z: 7 }, 2500)
                  .easing(TWEEN.Easing.Quadratic.InOut)
                  .start();

              // ปรับ focus ของ orbit control
              const box = new THREE.Box3().setFromObject(gltf.scene);
              const center = box.getCenter(new THREE.Vector3());
              new TWEEN.Tween(controls.target)
                  .to(center, 2500)
                  .easing(TWEEN.Easing.Quadratic.InOut)
                  .start();
          },
          (xhr) => console.log(`Main model loading: ${(xhr.loaded / xhr.total * 100).toFixed(2)}%`),
          (error) => console.error('❌ Main GLB load error:', error)
      );
  }

  // ======================
  // 🎛 dat.GUI
  // ======================
  const gui = new dat.GUI();
  const dirFolder = gui.addFolder('Directional Light');
  dirFolder.add(dirLight.position, 'x', -20, 20).step(0.1);
  dirFolder.add(dirLight.position, 'y', -20, 20).step(0.1);
  dirFolder.add(dirLight.position, 'z', -20, 20).step(0.1);
  dirFolder.add(dirLight, 'intensity', 0, 5).step(0.1);
  dirFolder.open();

  const ambFolder = gui.addFolder('Ambient Light');
  ambFolder.add(ambient, 'intensity', 0, 3).step(0.1);
  ambFolder.open();

  // ======================
  // 🔄 Animation Loop
  // ======================
  function animate() {
      requestAnimationFrame(animate);
      TWEEN.update();
      controls.update();
      renderer.render(scene, camera);
  }
  animate();

  // ======================
  // 📏 Resize Handler
  // ======================
  window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>
</body>
</html>
